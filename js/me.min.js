/*
 (c) 2015 Eugene V. Boiko
 minskelectroshop@gmail.com

 */
(function(){angular.module("shopModule",["ngSanitize","ngAnimate"]).config(["$locationProvider",function(a){a.html5Mode(!0)}]).controller("MainController",["$scope","$http","$sce","$location",function(a,g,l,m){this.getConfig=function(){var b=this;a.appData.user.ajax_progress=1;g.get("/ajax/http_get_config.php").success(function(c){if(c.config){c.config.filter_currency=""+a.appData.config.filter_currency;c.config.filter_sort_order=""+a.appData.config.filter_sort_order;c.config.filter_stock=""+a.appData.config.filter_stock;
  c.config.page_center_info=l.trustAsHtml(c.config.page_center_info);c.config.page_main_center_info=l.trustAsHtml(c.config.page_main_center_info);c.config.page_bottom_info=l.trustAsHtml(c.config.page_bottom_info);c.config.filter_minprice=0;c.config.filter_maxprice=9999;a.appData.config=c.config;a.appData.log[Date.now()]={type:"info",content:'<ul><li>Прайс можно скачать по ссылке <a href="/data_import/me2pt.zip" target="_blank">zip</a></li><li>Ошибка? Выделите соответствующий текст и нажмите Ctrl+Enter!</li><li>Заказ поступает диспетчеру в течение 2-х минут.</li><li>Доставка внутри МКАД +'+
  a.appData.config.currency_symbol+a.appData.config.delivery_cost+a.appData.config.currency_name+"</li><li>"+a.appData.config.currency_symbol+"1"+a.appData.config.currency_name+" = "+a.appData.config.currency_exchange_rate+" руб.</li><li>Время работы диспетчера: пн-пт 9-19,сб 9-16.</li>"};for(var d=ar2=[],e=location.pathname,e=e.split("/"),k=0;k<e.length;k++)ar2=
    e[k].split("~"),ar2[0]&&(d[ar2[0]]=decodeURIComponent(ar2[1]));var f=ar2=[];if(e=location.search)for(e=e.slice(1),e=e.split("&"),k=0;k<e.length;k++)ar2=e[k].split("="),f[ar2[0]]=decodeURIComponent(ar2[1]);void 0!==d.fc&&(a.appData.config.filter_currency=""+d.fc);void 0!==d.so&&(a.appData.config.filter_sort_order=""+d.so);void 0!==d.fs&&(a.appData.config.filter_stock=""+d.fs);void 0!==d.pg&&(a.appData.section.page.current=+d.pg);void 0!==d.p1&&(a.appData.config.filter_minprice=+d.p1?+d.p1:0);void 0!==
  d.p2&&(a.appData.config.filter_maxprice=+d.p2?+d.p2:9999);d.p?b.getProduct(d.p):d.c?b.getSection(d.c):d.s?b.getSearch(d.s):f.subscribe||f.unsubscribe||f.confirm||b.showNews();a.appData.user.referral=f.ref;f.subscribe&&b.getConfirmation(f.subscribe,"subscribe");f.unsubscribe&&b.getConfirmation(f.unsubscribe,"unsubscribe");f.confirm&&b.getConfirmation(f.confirm,"review")}c.error&&(a.appData.log[Date.now()]={type:"danger",content:c.error});a.appData.user.ajax_progress=0}).error(function(){a.appData.log[Date.now()]=
{type:"danger",content:"Инициализация магазина. Пожалуйста, обратитесь к администратору сайта!"};a.appData.user.ajax_progress=0})};this.getSection=function(b){var c=a.appData.config.filter_minprice,
  d=a.appData.config.filter_maxprice,e=a.appData.config.currency_exchange_rate;1==a.appData.config.filter_currency&&(c=Math.round(c/e),d=Math.round(d/e));if(d){var k=this,f=b==a.appData.section.id?a.appData.section.page.current:1,c="?id="+b+"&current_page="+f+"&filter_minprice="+c+"&filter_maxprice="+d+"&filter_sort_order="+a.appData.config.filter_sort_order+"&filter_stock="+a.appData.config.filter_stock;a.appData.user.ajax_progress=1;g.get("/ajax/http_get_section.php"+c).success(function(c){c.error&&
(a.appData.log[Date.now()]={type:"danger",content:"При получении данных с сервера. "+c.error+"Пожалуйста, обратитесь к администратору сайта!"});if(c.product){angular.forEach(c.product,
  function(a,b){var d=143<a.short_desc.length?a.short_desc.slice(0,144)+"…":a.short_desc;c.product[b].short_desc=l.trustAsHtml(d)});a.appData.product={};a.appData.user.search_text="";a.appData.section={product:{},page:{id:{}}};a.appData.section.product=c.product;a.appData.section.subsection=c.subsection;a.appData.section.product_count=+c.product_count;a.appData.section.subsection_count=+c.subsection_count;a.appData.section.name=c.name;a.appData.section.description=l.trustAsHtml(c.description);
  a.appData.section.page.product_count=Math.min(a.appData.section.product_count-(f-1)*a.appData.config.products_per_page,a.appData.config.products_per_page);a.appData.section.page.count=~~(a.appData.section.product_count/a.appData.config.products_per_page)+1;for(var d=0;d<a.appData.section.page.count;d++)a.appData.section.page.id[1E3+d]=d+1;a.appData.section.id=b;a.appData.section.page.current=f;a.appData.state=["section"];k.getNavigation(b);a.appData.user.ajax_progress=0;m.url("/c~"+a.appData.section.id+
    "/fc~"+a.appData.config.filter_currency+"/so~"+a.appData.config.filter_sort_order+"/fs~"+a.appData.config.filter_stock+"/pg~"+a.appData.section.page.current+"/p1~"+a.appData.config.filter_minprice+"/p2~"+a.appData.config.filter_maxprice);a.appData.config.title=a.appData.section.name}}).error(function(){a.appData.log[Date.now()]={type:"danger",content:"При получении данных с сервера. Пожалуйста, обратитесь к администратору сайта!"};
  a.appData.user.ajax_progress=0})}};this.getSearch=function(b){a.appData.user.search_text=b;b=a.appData.config.filter_minprice;var c=a.appData.config.filter_maxprice,d=a.appData.config.currency_exchange_rate;1==a.appData.config.filter_currency&&(b=Math.round(b/d),c=Math.round(c/d));if((a.appData.user.search_text+"").length&&c){var e=a.appData.section.page.current;b="?text="+a.appData.user.search_text+"&current_page="+e+"&filter_minprice="+b+"&filter_maxprice="+c+"&filter_sort_order="+a.appData.config.filter_sort_order+
  "&filter_stock="+a.appData.config.filter_stock;a.appData.user.ajax_progress=1;g.get("/ajax/http_get_search.php"+b).success(function(b){b.error&&(a.appData.log[Date.now()]={type:"danger",content:b.error});if(b.product){angular.forEach(b.product,function(a,c){var d=143<a.short_desc.length?a.short_desc.slice(0,144)+"…":a.short_desc;b.product[c].short_desc=l.trustAsHtml(d)});a.appData.product={};a.appData.navigation=[a.appData.navigation[0]];a.appData.section={product:{},page:{id:{}}};a.appData.section.product=
  b.product;a.appData.section.product_count=+b.product_count;a.appData.section.page.product_count=Math.min(+b.product_count-(e-1)*a.appData.config.products_per_page,a.appData.config.products_per_page);a.appData.section.page.count=~~(a.appData.section.product_count/a.appData.config.products_per_page)+1;for(var c=0;c<a.appData.section.page.count;c++)a.appData.section.page.id[1E3+c]=c+1;a.appData.state=["search"];a.appData.section.page.current=e;a.appData.user.ajax_progress=0}m.url("/s~"+a.appData.user.search_text+
  "/fc~"+a.appData.config.filter_currency+"/so~"+a.appData.config.filter_sort_order+"/fs~"+a.appData.config.filter_stock+"/pg~"+a.appData.section.page.current+"/p1~"+a.appData.config.filter_minprice+"/p2~"+a.appData.config.filter_maxprice);a.appData.config.title=a.appData.user.search_text}).error(function(){a.appData.log[Date.now()]={type:"danger",content:"При получении данных с сервера. Пожалуйста, обратитесь к администратору сайта!"};
  a.appData.user.ajax_progress=0})}else this.getSection(1)};this.getNavigation=function(b){a.appData.user.ajax_progress=1;g.get("/ajax/http_get_navigation.php?id="+b).success(function(b){b.navigation&&(a.appData.navigation=b.navigation);b.error&&(a.appData.log[Date.now()]={type:"danger",content:b.error});a.appData.user.ajax_progress=0}).error(function(){a.appData.log[Date.now()]={type:"danger",content:"При получении данных с сервера. Пожалуйста, обратитесь к администратору сайта!"};
  a.appData.user.ajax_progress=0})};this.getProduct=function(b){var c=this;a.appData.user.ajax_progress=1;g.get("/ajax/http_get_product.php?id="+b).success(function(d){d.product&&(d.product.description=l.trustAsHtml(d.product.description),a.appData.section={},a.appData.user.search_text="",a.appData.section.page={current:1},a.appData.state=["product"],a.appData.product=d.product,c.getNavigation(b),a.appData.user.ajax_progress=0,m.url("/p~"+a.appData.product.id+"/fc~"+a.appData.config.filter_currency+
  "/so~"+a.appData.config.filter_sort_order+"/fs~"+a.appData.config.filter_stock),a.appData.config.title=a.appData.product.name);d.error&&(a.appData.log[Date.now()]={type:"danger",content:d.error})}).error(function(){a.appData.log[Date.now()]={type:"danger",content:"При получении данных с сервера. Пожалуйста, обратитесь к администратору сайта!"};
  a.appData.user.ajax_progress=0})};this.getProductToCart=function(b){b in a.appData.order||(a.appData.order[b]={count:1});var c=!1;a.appData.order.product[b].name&&(c=!0);c||(a.appData.user.ajax_progress=1,g.get("/ajax/http_get_product.php?id="+b).success(function(c){if(c.product){var e=c.product.short_desc.replace(/<br\/>/g," ");c.product.short_desc=143<e.length?e.slice(0,144)+"…":e;c.product.id=b;c.product.count=a.appData.order.product[b].count;a.appData.order.product[b]=c.product;a.appData.log[Date.now()]=
{type:"success",content:"Товар добавлен в корзину. Чтобы перейти к оформлению, необходимо кликнуть на изображение корзины в самом верху."}}c.error&&
(a.appData.log[Date.now()]={type:"danger",content:c.error});a.appData.user.ajax_progress=0}).error(function(){a.appData.log[Date.now()]={type:"danger",content:"Товар не добавлен в корзину. Пожалуйста, обратитесь к администратору сайта!"};
  a.appData.user.ajax_progress=0}))};this.getConfirmation=function(b,c){a.appData.user.ajax_progress=1;g.get("/ajax/http_get_confirmation.php?code="+b+"&command="+c).success(function(b){b.success&&(a.appData.log[Date.now()]={type:"success",content:b.success});b.error&&(a.appData.log[Date.now()]={type:"danger",content:b.error});a.appData.user.ajax_progress=0}).error(function(){a.appData.log[Date.now()]={type:"danger",content:"При получении данных с сервера. Пожалуйста, обратитесь к администратору сайта!"};
  a.appData.user.ajax_progress=0})};this.getReview=function(b){a.appData.user.ajax_progress=1;g.get("/ajax/http_get_review.php?id="+b).success(function(b){b.review&&(a.appData.review=b.review);b.error&&(a.appData.log[Date.now()]={type:"danger",content:b.error});a.appData.user.ajax_progress=0}).error(function(){a.appData.log[Date.now()]={type:"danger",content:"При получении данных с сервера. Пожалуйста, обратитесь к администратору сайта!"};
  a.appData.user.ajax_progress=0})};this.postOrder=function(){var b={order:{user:a.appData.user,product:[]}};angular.forEach(a.appData.order.product,function(a,d){b.order.product.push({id:d,count:a.count})});a.appData.user.ajax_progress=1;g.post("/ajax/http_post_order.php",b).success(function(b){b.error&&(a.appData.log[Date.now()]={type:"danger",content:b.error});b.success&&(a.appData.order={product:{}},a.appData.log[Date.now()]={type:"success",content:"Ваш заказ отправлен. С Вами свяжутся по указанному в заказе телефону в течение "+
a.appData.config.order_reaction_time+"."});a.appData.state.pop();a.appData.user.ajax_progress=0}).error(function(){a.appData.log[Date.now()]={type:"danger",content:"Заказ не отправлен. Пожалуйста, обратитесь к администратору сайта!"};
  a.appData.user.ajax_progress=0})};this.postError=function(){var b={subject:"ME Content Error",message:"Сообщение об ошибке от пользователя.<br><br>* Имя: "+a.appData.user.name+"<br>* Телефон: "+a.appData.user.phone+"<br>* E-mail: "+a.appData.user.email+"<br>* Контекст: "+
a.appData.user.text.selected+"<br>* Описание: "+a.appData.user.comment+"<br>* Текущая страница: "+location.toString(),captcha_id:a.appData.user.captcha.id,captcha_value:a.appData.user.captcha.value};a.appData.user.ajax_progress=1;g.post("/ajax/http_post_feedback.php",b).success(function(b){b.error&&(a.appData.log[Date.now()]={type:"danger",content:b.error});b.success&&(a.appData.log[Date.now()]=
{type:"success",content:b.success},a.appData.user.comment="",a.appData.user.captcha.value="");a.appData.state.pop();a.appData.user.ajax_progress=0}).error(function(){a.appData.log[Date.now()]={type:"danger",content:"При получении данных с сервера. Пожалуйста, обратитесь к администратору сайта!"};
  a.appData.user.ajax_progress=0})};this.postFeedback=function(){var b={subject:"ME Feedback",message:"Сообщение от пользователя.<br><br>* Имя: "+a.appData.user.name+"<br>* Телефон: "+a.appData.user.phone+"<br>* Email: "+a.appData.user.email+"<br>* Сообщение: "+a.appData.user.comment,captcha_id:a.appData.user.captcha.id,
  captcha_value:a.appData.user.captcha.value};a.appData.user.ajax_progress=1;g.post("/ajax/http_post_feedback.php",b).success(function(b){b.error&&(a.appData.log[Date.now()]={type:"danger",content:b.error});b.success&&(a.appData.log[Date.now()]={type:"success",content:b.success},a.appData.user.comment="",a.appData.user.captcha.value="");a.appData.state.pop();a.appData.user.ajax_progress=0}).error(function(){a.appData.log[Date.now()]={type:"danger",content:"При получении данных с сервера. Пожалуйста, обратитесь к администратору сайта!"};
  a.appData.user.ajax_progress=0})};this.postReview=function(){var b={review:{user_name:a.appData.user.name,user_phone:a.appData.user.phone,user_email:a.appData.user.email,product_review:a.appData.user.comment,product_rating:a.appData.user.rating,product_id:a.appData.product.id,product_name:a.appData.product.name,captcha_id:a.appData.user.captcha.id,captcha_value:a.appData.user.captcha.value}};a.appData.user.ajax_progress=1;g.post("/ajax/http_post_review.php",b).success(function(b){b.error&&(a.appData.log[Date.now()]=
{type:"danger",content:b.error});b.success&&(a.appData.log[Date.now()]={type:"success",content:b.success},a.appData.user.comment="",a.appData.user.captcha.value="");a.appData.state.pop();a.appData.user.ajax_progress=0}).error(function(){a.appData.log[Date.now()]={type:"danger",content:"При получении данных с сервера. Пожалуйста, обратитесь к администратору сайта!"};
  a.appData.user.ajax_progress=0})};this.calcOrderProductsPrice=function(){var b=0;angular.forEach(a.appData.order.product,function(a,d){b+=+a.price*+a.count});return b};this.calcOrderDeliveryPrice=function(){var b=!1;angular.forEach(a.appData.order.product,function(a,d){+a.delivery_free||(b=!0)});return b?+a.appData.config.delivery_cost:0};this.calcNextPageProductCount=function(){return Math.min(a.appData.section.product_count-a.appData.section.page.current*a.appData.config.products_per_page,a.appData.config.products_per_page)};
  this.calcOrderTotalPrice=function(){return+this.calcOrderProductsPrice()+this.calcOrderDeliveryPrice()};this.calcOrderProductsCount=function(){return Object.keys(a.appData.order.product).length};this.removeProductFromCart=function(b){angular.forEach(a.appData.order.product,function(c,d){d==b&&delete a.appData.order.product[d]});this.calcOrderProductsPrice()||(this.previousState(),a.appData.log[Date.now()]={type:"info",content:"Корзина пуста. Для оформления заказа необходимо добавить в корзину товар!"})};
  this.removeMessage=function(b){delete a.appData.log[b]};this.showCart=function(){this.isCurrentState("cart")?a.appData.log[Date.now()]={type:"info",content:"Корзина уже открыта!"}:0<this.calcOrderProductsCount()?(a.appData.user.captcha.id=Math.floor(1+999999998*Math.random()),a.appData.state.push("cart")):a.appData.log[Date.now()]={type:"info",content:"Корзина пуста. Для оформления заказа необходимо добавить в корзину товар!"}};
  this.showActiveState=function(b){0<b&&b<=a.appData.section.page.count&&(a.appData.section.page.current=b);switch(a.appData.state[a.appData.state.length-1]){case "product":this.getProduct(a.appData.product.id);break;case "section":this.getSection(a.appData.section.id);break;case "search":this.getSearch(a.appData.user.search_text);break;default:a.appData.log[Date.now()]={type:"danger",content:"Ошибка в определении текущего состояния. Пожалуйста, обратитесь к администратору сайта!"}}};
  this.showReview=function(b){a.appData.product.id!=b&&angular.forEach(a.appData.section.product,function(c,d){c.id==b&&(a.appData.product=c)});this.isCurrentState("review")?a.appData.log[Date.now()]={type:"info",content:"Отзыв уже открыт!"}:(a.appData.state.push("review"),a.appData.user.captcha.id=Math.floor(1+999999998*Math.random()),this.getReview(b))};this.showFeedback=function(){this.isCurrentState("feedback")?a.appData.log[Date.now()]=
  {type:"info",content:"Обратная связь уже открыта!"}:(a.appData.state.push("feedback"),a.appData.user.captcha.id=Math.floor(1+999999998*Math.random()))};this.showNews=function(){this.isCurrentState("news")||a.appData.state.push("news")};this.showMe=function(){this.isCurrentState("me")||a.appData.state.push("me")};this.showError=function(){var b="";"undefined"!=typeof window.getSelection?
    b=window.getSelection().toString():"undefined"!=typeof document.selection&&"Text"==document.selection.type&&(b=document.selection.createRange().text);a.appData.user.text.selected=b;this.isCurrentState("error")?a.appData.log[Date.now()]={type:"info",content:"Сообщение уже открыто!"}:(a.appData.state.push("error"),a.appData.user.captcha.id=Math.floor(1+999999998*Math.random()))};this.popupSoc=function(a){h=
    encodeURIComponent(location.toString());t=encodeURIComponent(document.title);switch(a){case 1:h="vkontakte.ru/share.php?url="+h+"&title="+t;break;case 2:h="odnoklassniki.ru/dk?st.cmd=addShare&st.s=1000&st._surl="+h+"&tkn=3009";break;case 3:h="www.livejournal.com/update.bml?mode=full&subject="+t+"&event="+h;break;case 4:h="twitter.com/timeline/home?status="+t+"%20"+h;break;case 5:h="www.facebook.com/share.php?u="+h;break;case 6:h="wow.ya.ru/posts_share_link.xml?url="+h+"&title="+t;break;case 7:h="connect.mail.ru/share?url="+
    h+"&title="+t+"&description=&imageurl=";break;case 8:h="moikrug.ru/share?ie=utf-8&url="+h+"&title="+t+"&description="}window.open("http://"+h,"Soc","screenX=100,screenY=100,height=500,width=500,location=no,toolbar=no,directories=no,menubar=no,status=no")};this.showPage=function(b){var c=+a.appData.section.page.current+a.appData.config.neighbors_count+1,d=+a.appData.section.page.count;return b>+a.appData.section.page.current-a.appData.config.neighbors_count-1&&b<c&&1<b&&b<d};this.showPageDots=function(b){var c=
    +a.appData.section.page.current+a.appData.config.neighbors_count+2;return b==+a.appData.section.page.current-a.appData.config.neighbors_count-2||b==c};this.showPreviousPage=function(){this.showActiveState(a.appData.section.page.current-1)};this.showNextPage=function(){this.showActiveState(a.appData.section.page.current+1)};this.onKeyUp=function(b){a.appData.user.text.typed+=String.fromCharCode(b.keyCode);a.appData.user.text.typed.slice(1,11);0<=a.appData.user.text.typed.search(/easteregg/i)&&(a.appData.state.push("easteregg"),
    a.appData.user.text.typed="");27!=b.keyCode||this.isCurrentState("product")||this.isCurrentState("search")||this.isCurrentState("section")||this.previousState();b.ctrlKey&&13==b.keyCode&&this.showError();a.$digest()};this.showPagination=function(){return(this.isCurrentState("section")||this.isCurrentState("search"))&&1<a.appData.section.page.count};this.showNavigation=function(){return this.isCurrentState("product")||this.isCurrentState("section")||this.isCurrentState("search")};this.filterCurrency=
    function(b){switch(+a.appData.config.filter_currency){default:case 0:var c="",d=" у.е.";b=+b;break;case 1:c="",d=" р.",b=+b*a.appData.config.currency_exchange_rate}return b?c+b+d:"-"};this.filterHighlightSearchSubstring=function(b){if(this.isCurrentState("search")){for(var c=a.appData.user.search_text,d=0;11>d;d++)c=c.replace("\\()[].^$|?+"[d],"\\()[].^$|?+"[0]+"\\()[].^$|?+"[d]);c=c.split(" ");for(d=0;d<c.length;d++)b=b.replace(new RegExp("("+c[d]+")","ig"),"<span class='text-success'>$1</span>")}return b};
  this.changeCurrency=function(){var b=a.appData.config.filter_minprice,c=a.appData.config.filter_maxprice,d=a.appData.config.currency_exchange_rate;switch(a.appData.config.filter_currency){default:case "0":b=Math.round(b/d);c=Math.round(c/d);break;case "1":b=Math.round(b*d),c=Math.round(c*d)}m.url((a.appData.section.id?"/c~"+a.appData.section.id:"")+(a.appData.user.search_text?"/s~"+a.appData.user.search_text:"")+"/fc~"+a.appData.config.filter_currency+"/so~"+a.appData.config.filter_sort_order+"/fs~"+
    a.appData.config.filter_stock+"/pg~"+a.appData.section.page.current+"/p1~"+b+"/p2~"+c);a.appData.config.filter_minprice=b;a.appData.config.filter_maxprice=c};this.isCurrentState=function(b){return a.appData.state[a.appData.state.length-1]===b};this.previousState=function(){a.appData.state.pop();a.appData.state.length||this.getSection(1)};this.init=function(){a.appData={order:{product:{}},user:{rating:"0",captcha:{},text:{typed:""}},navigation:{0:{id:"1",name:"Главная",
    type:"section"}},section:{page:{current:1}},config:{filter_currency:0,filter_sort_order:0,filter_stock:0,filter_minprice:0,filter_maxprice:9999,currency_exchange_rate:1,currency_name:" у.е.",currency_symbol:"",products_per_page:50,delivery_cost:3},state:[],log:{}};var b=this;document.getElementsByTagName("body")[0].addEventListener("keyup",function(a){b.onKeyUp(a)},!0);this.getConfig()};this.init()}])})();